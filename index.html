<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #111827;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .glass-card { /* For modals */
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; transition: opacity 0.3s ease;
        }
        .modal-content { width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        .segmented-control { display: flex; border-radius: 0.5rem; background-color: #e5e7eb; padding: 4px; border: 1px solid #d1d5db; }
        .segmented-control input[type="radio"] { display: none; }
        .segmented-control label { flex: 1; text-align: center; padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; transition: all 0.3s ease; color: #4b5563; font-weight: 600; }
        .segmented-control input[type="radio"]:checked + label { background-color: #0891b2; color: white; box-shadow: 0 2px 10px rgba(8, 145, 178, 0.4); }
        
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .subtheme-tag {
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .subtheme-tag.selected {
            background-color: #0891b2;
            color: white;
            border-color: #0891b2;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="min-h-screen p-4 sm:p-6 lg:p-8 flex flex-col items-center">
        
        <header class="w-full max-w-5xl text-center mb-8">
            <h1 class="font-orbitron text-3xl sm:text-4xl lg:text-5xl font-bold text-cyan-700 tracking-wider">Global Intelligence Dashboard</h1>
            <p class="mt-2 text-gray-600">Generate discussion-ready intelligence on global issues.</p>
        </header>

        <section id="input-section" class="w-full max-w-4xl card rounded-xl p-6 sm:p-8 transition-all duration-500">
            <div class="space-y-6">
                <div>
                    <h3 class="font-orbitron text-xl font-semibold text-gray-800 mb-4">1. Select Themes (Mix & Match)</h3>
                    <div id="theme-selection-container" class="space-y-4">
                        <!-- Theme categories and sub-themes populated by JS -->
                    </div>
                </div>
                
                <div>
                    <label for="problem-statement" class="block text-sm font-medium text-gray-700 mb-2">2. Enter Problem or Keyword</label>
                    <input type="text" id="problem-statement" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" placeholder="e.g., AI impact on jobs, Carbon capture solutions...">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">3. Select Analysis Level</label>
                    <div id="analysis-level" class="segmented-control">
                        <input type="radio" id="level-beginner" name="analysis-level" value="Beginner">
                        <label for="level-beginner">Beginner <span class="block text-xs font-normal opacity-70">(High-level overview)</span></label>
                        <input type="radio" id="level-intermediate" name="analysis-level" value="Intermediate" checked>
                        <label for="level-intermediate">Intermediate <span class="block text-xs font-normal opacity-70">(Detailed stats & trends)</span></label>
                        <input type="radio" id="level-analyst" name="analysis-level" value="Analyst">
                        <label for="level-analyst">Analyst <span class="block text-xs font-normal opacity-70">(Granular data & implications)</span></label>
                    </div>
                </div>
                <div>
                    <button id="gamify-btn" class="w-full font-orbitron bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-cyan-600/50 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btn-text">GENERATE INTEL</span>
                        <svg id="btn-loader" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </div>
        </section>

        <section id="loader-section" class="hidden w-full max-w-3xl text-center p-8 mt-8">
            <div class="relative w-full h-40 card rounded-xl flex flex-col justify-center items-center overflow-hidden">
                <div class="scanner-bar"></div>
                <h2 id="loader-text" class="font-orbitron text-2xl text-cyan-700 z-10">GENERATING INTELLIGENCE BRIEF...</h2>
                <p class="text-gray-600 mt-2 z-10">Tasking Global Analysis AI...</p>
            </div>
        </section>

        <section id="results-section" class="hidden w-full max-w-7xl mt-10 fade-in"></section>
        
        <div id="error-modal" class="modal-backdrop hidden">
            <div class="modal-content glass-card rounded-xl p-8 shadow-2xl text-center border-red-500/50 border-2">
                <h3 class="font-orbitron text-2xl font-bold text-red-400 mb-4">Analysis Failed</h3>
                <p id="error-message" class="text-gray-300 mb-6">Could not generate insights.</p>
                <button id="close-error-modal-btn" class="font-orbitron bg-red-500 hover:bg-red-400 text-white font-bold py-2 px-6 rounded-lg">TRY AGAIN</button>
            </div>
        </div>
        
        <div id="ai-feature-modal" class="modal-backdrop hidden opacity-0">
            <div class="modal-content glass-card rounded-xl p-6 sm:p-8 shadow-2xl border-cyan-500/50 border-2 flex flex-col text-white">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h3 id="ai-modal-title" class="font-orbitron text-xl sm:text-2xl font-bold text-cyan-300"></h3>
                    <button id="close-ai-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div id="ai-modal-content" class="flex-grow overflow-y-auto pr-2"></div>
            </div>
        </div>

    </div>

    <script>
        // --- DOM ELEMENTS ---
        const inputSection = document.getElementById('input-section');
        const loaderSection = document.getElementById('loader-section');
        const resultsSection = document.getElementById('results-section');
        const gamifyBtn = document.getElementById('gamify-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const problemStatementInput = document.getElementById('problem-statement');
        const themeSelectionContainer = document.getElementById('theme-selection-container');
        
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeErrorModalBtn = document.getElementById('close-error-modal-btn');
        
        const aiFeatureModal = document.getElementById('ai-feature-modal');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiModalContent = document.getElementById('ai-modal-content');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        
        let activeCharts = [];
        let currentReportData = null;
        let isAILoading = false;

        // --- THEME DATA ---
        const themes = {
            "Technology": ["AI & Automation", "Cybersecurity", "Quantum Computing", "5G & Connectivity", "Biotechnology"],
            "Environment": ["Climate Change", "Water Scarcity", "Biodiversity Loss", "Circular Economy", "Sustainable Energy"],
            "Economy": ["Global Trade", "Inflation", "Future of Work", "Supply Chains", "Cryptocurrency"],
            "Socio-Political": ["Geopolitics", "Misinformation", "Demographics", "Health Security", "Urbanization"]
        };
        
        // --- INITIALIZATION ---
        function initializeThemes() {
            for (const category in themes) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'card rounded-lg p-4';
                
                const categoryTitle = document.createElement('h4');
                categoryTitle.className = 'font-semibold text-gray-800 mb-3';
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);

                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'flex flex-wrap gap-2';
                
                themes[category].forEach(theme => {
                    const tag = document.createElement('div');
                    tag.className = 'subtheme-tag border border-gray-300 text-gray-600 px-3 py-1 rounded-full text-sm';
                    tag.textContent = theme;
                    tag.dataset.theme = theme;
                    tag.addEventListener('click', () => {
                        tag.classList.toggle('selected');
                    });
                    tagsContainer.appendChild(tag);
                });
                categoryDiv.appendChild(tagsContainer);
                themeSelectionContainer.appendChild(categoryDiv);
            }
        }
        initializeThemes();

        // --- EVENT LISTENERS ---
        gamifyBtn.addEventListener('click', runGamification);
        closeErrorModalBtn.addEventListener('click', () => {
            errorModal.classList.add('hidden');
            resetApp();
        });
        closeAiModalBtn.addEventListener('click', () => {
            aiFeatureModal.classList.add('opacity-0', 'hidden');
        });

        // --- CORE LOGIC ---
        function setLoading(isLoading) {
            isAILoading = isLoading;
            gamifyBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            btnLoader.classList.toggle('hidden', !isLoading);
        }

        async function callGeminiAPI(prompt, schema) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            
            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Body:", errorBody);
                if (response.status === 401 || response.status === 403) {
                    throw new Error(`Authentication failed (Status ${response.status}). This may be an issue with the API key configuration in the environment.`);
                }
                throw new Error(`API request failed with status ${response.status}.`);
            }
            
            const result = await response.json();
            if (!result.candidates || !result.candidates[0].content.parts[0].text) throw new Error("Invalid response structure from AI.");
            return JSON.parse(result.candidates[0].content.parts[0].text);
        }

        async function runGamification() {
            if (isAILoading) return;
            const problem = problemStatementInput.value;
            const selectedThemes = Array.from(document.querySelectorAll('.subtheme-tag.selected')).map(tag => tag.dataset.theme);

            if (selectedThemes.length === 0) {
                errorMessage.textContent = 'Please select at least one theme.';
                errorModal.classList.remove('hidden');
                return;
            }
            if (!problem.trim()) {
                errorMessage.textContent = 'Please enter a problem or keyword.';
                errorModal.classList.remove('hidden');
                return;
            }

            const themeString = selectedThemes.join(', ');

            setLoading(true);
            inputSection.classList.add('hidden');
            resultsSection.innerHTML = '';
            resultsSection.classList.add('hidden');
            loaderSection.classList.remove('hidden');

            try {
                const analysisLevel = document.querySelector('input[name="analysis-level"]:checked').value;
                const schema = { type: "OBJECT", properties: { "title": { "type": "STRING" }, "didYouKnow": { "type": "STRING" }, "stats": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "label": { "type": "STRING" }, "value": { "type": "STRING" }, "unit": { "type": "STRING" } } } }, "expertTake": { "type": "OBJECT", "properties": { "keyInsight": { "type": "STRING" }, "mainDebate": { "type": "STRING" }, "futureOutlook": { "type": "STRING" } } }, "charts": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "chartType": { "type": "STRING" }, "title": { "type": "STRING" }, "labels": { "type": "ARRAY", "items": { "type": "STRING" } }, "datasets": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "label": { "type": "STRING" }, "data": { "type": "ARRAY", "items": { "type": "NUMBER" } } } } } } } } } };
                
                let prompt;
                if (analysisLevel === 'Analyst') {
                    prompt = `
                    Generate a professional, data-driven intelligence brief for the query: "${problem}" within the combined themes of "${themeString}". The audience is an expert-level Analyst. Your response must be objective, concise, and use clear, direct language.

                    CRITICAL INSTRUCTIONS:
                    1.  **Objective Data & Proof**: All data points in "Key Metrics" and charts must be specific and verifiable (e.g., use country names, percentages, financial figures like '$2.5B'). Back up claims with numbers. Avoid speculative language.
                    2.  **Concise & Insightful Expert Take**: Each field ('keyInsight', 'mainDebate', 'futureOutlook') must be strictly one impactful sentence. For 'keyInsight', provide a conclusion backed by an analogy or a data point from your analysis (e.g., "This market shift is like the move from landlines to mobile, with legacy players losing 50% share."). For 'mainDebate', frame it as a testable hypothesis (e.g., "A key hypothesis is that if China's investment in AI continues, they will surpass US capabilities by 2028.").
                    3.  **Narrative-Driven Charts**: Generate exactly four distinct charts that tell a cohesive story without repeating data.
                        - Chart 1 (Snapshot): A Pie/Doughnut chart of current composition (e.g., Market Share by Company).
                        - Chart 2 (Trend): A Line chart showing historical data and a future projection (e.g., Adoption Rate 2020-2026).
                        - Chart 3 (Comparison): A Bar chart comparing specific entities (e.g., R&D Spending by Country).
                        - Chart 4 (Insight): A Radar or Scatter chart revealing a deeper data relationship (e.g., Correlation between Investment and Patent Filings).
                    4.  **Did You Know**: Provide a single, surprising, and verifiable statistic related to the core problem.
                    5.  **Key Metrics**: Generate exactly 4 or 6 metrics for a balanced grid.
                    `;
                } else {
                    prompt = `Generate a high-impact intelligence brief for the query: "${problem}" on the themes of "${themeString}" for a "${analysisLevel}" audience. Create 1-2 simple charts (bar, line, pie). The 'expertTake' fields must be single, concise sentences. Include a 'didYouKnow' fact. Use clear, simple language.`;
                }
                
                currentReportData = await callGeminiAPI(prompt, schema);
                currentReportData.problem = problem;
                currentReportData.level = analysisLevel;

                setTimeout(() => {
                    loaderSection.classList.add('hidden');
                    populateResults(currentReportData);
                    resultsSection.classList.remove('hidden');
                    setLoading(false);
                }, 1000);

            } catch (error) {
                console.error("Error during gamification:", error);
                if (error.message.includes("Authentication failed")) {
                    errorMessage.innerHTML = `${error.message}<br><br><span class="text-sm text-gray-400">This can happen if the environment's API key is not configured correctly. Please check the platform's documentation.</span>`;
                } else {
                     errorMessage.textContent = error.message || "An unknown error occurred during the analysis.";
                }
                errorModal.classList.remove('hidden');
                setLoading(false);
            }
        }

        function populateResults(data) {
            const { problem, level, didYouKnow } = data;
            const stats = data.stats || [];
            const expertTake = data.expertTake || { keyInsight: 'N/A', mainDebate: 'N/A', futureOutlook: 'N/A' };
            const charts = data.charts || [];

            // --- REVERTED TO INTEGRATED DASHBOARD LAYOUT ---
            const resultsHTML = `
                <div class="text-center mb-8">
                    <h2 class="font-orbitron text-2xl sm:text-3xl font-bold text-cyan-700">${data.title || 'Intelligence Brief'}</h2>
                    <div class="flex justify-center items-center gap-4 mt-2">
                        <p class="text-gray-500">Query: "${problem}"</p>
                        <span class="bg-cyan-100 text-cyan-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">LEVEL: ${level.toUpperCase()}</span>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 card rounded-xl p-6 slide-in-bottom" style="animation-delay: 100ms;">
                            <h3 class="font-orbitron text-xl font-semibold text-cyan-600 mb-2">Did You Know?</h3>
                            <p class="text-gray-700 text-lg">${didYouKnow || 'No surprising fact available.'}</p>
                        </div>
                        <div class="lg:col-span-2 card rounded-xl p-6 slide-in-bottom" style="animation-delay: 200ms;">
                            <h3 class="font-orbitron text-xl font-semibold text-gray-800 mb-4">Key Metrics</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">${stats.map(stat => `<div class="bg-gray-50 p-3 rounded-lg border"><p class="text-2xl font-orbitron font-bold text-cyan-700">${stat.value}</p><p class="text-sm text-gray-600">${stat.label}</p><p class="text-xs text-gray-400">${stat.unit || ''}</p></div>`).join('')}</div>
                        </div>
                    </div>

                    <div class="card rounded-xl p-6 slide-in-bottom" style="animation-delay: 300ms;">
                        <h3 class="font-orbitron text-xl font-semibold text-gray-800 mb-4 text-center">Visual Intelligence</h3>
                        <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${charts.map((chart, index) => `<div class="h-64 card p-2"><canvas id="trends-chart-${index}"></canvas></div>`).join('')}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card rounded-xl p-6 slide-in-bottom" style="animation-delay: 400ms;">
                            <h3 class="font-orbitron text-xl font-semibold text-gray-800 mb-4">Expert Take</h3>
                            <div class="space-y-4 text-gray-600">
                                <div class="flex items-start"><svg class="w-6 h-6 mr-3 text-cyan-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><div><h4 class="font-semibold text-gray-800">Key Insight (Proof)</h4><p>${expertTake.keyInsight}</p></div></div>
                                <div class="flex items-start"><svg class="w-6 h-6 mr-3 text-cyan-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><div><h4 class="font-semibold text-gray-800">Main Hypothesis</h4><p>${expertTake.mainDebate}</p></div></div>
                                <div class="flex items-start"><svg class="w-6 h-6 mr-3 text-cyan-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg><div><h4 class="font-semibold text-gray-800">Future Outlook</h4><p>${expertTake.futureOutlook}</p></div></div>
                            </div>
                        </div>
                        <div class="card rounded-xl p-6 slide-in-bottom" style="animation-delay: 500ms;">
                            <h3 class="font-orbitron text-xl font-semibold text-gray-800 mb-4">Deeper Analysis ✨</h3>
                            <div class="grid grid-cols-1 gap-4 h-full content-center">
                                <button id="counter-args-btn" class="font-orbitron bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition-all">Suggest Counter-Arguments</button>
                                <button id="actionable-steps-btn" class="font-orbitron bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-all">Generate Actionable Steps</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-8"><button id="reset-btn" class="font-orbitron bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">GENERATE NEW BRIEF</button></div>
            `;
            resultsSection.innerHTML = resultsHTML;
            
            document.getElementById('reset-btn').addEventListener('click', resetApp);
            document.getElementById('counter-args-btn').addEventListener('click', getCounterArguments);
            document.getElementById('actionable-steps-btn').addEventListener('click', getActionableSteps);

            renderCharts(charts);
        }

        function renderCharts(charts) {
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];
            const chartColors = [{ bg: 'rgba(8, 145, 178, 0.6)', border: 'rgb(8, 145, 178)' }, { bg: 'rgba(107, 114, 128, 0.6)', border: 'rgb(107, 114, 128)' }, { bg: 'rgba(217, 119, 6, 0.6)', border: 'rgb(217, 119, 6)' }, { bg: 'rgba(220, 38, 38, 0.6)', border: 'rgb(220, 38, 38)' }];
            (charts || []).forEach((chartData, index) => {
                const ctx = document.getElementById(`trends-chart-${index}`).getContext('2d');
                const newChart = new Chart(ctx, {
                    type: chartData.chartType?.toLowerCase() || 'bar',
                    data: { labels: chartData.labels, datasets: (chartData.datasets || []).map((d, i) => ({ label: d.label, data: d.data, backgroundColor: chartColors[i % chartColors.length].bg, borderColor: chartColors[i % chartColors.length].border, borderWidth: 1.5, borderRadius: 4, fill: chartData.chartType?.toLowerCase() === 'line' })) },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: (chartData.datasets || []).length > 1, labels: { color: '#4b5563' } }, title: { display: true, text: chartData.title, color: '#1f2937', font: { family: "'Inter', sans-serif", size: 14 } } }, scales: { y: { beginAtZero: true, grid: { color: '#e5e7eb' }, ticks: { color: '#4b5563' } }, x: { grid: { display: false }, ticks: { color: '#4b5563' } } } }
                });
                activeCharts.push(newChart);
            });
        }

        function showAiModal(title, content) {
            aiModalTitle.textContent = title;
            aiModalContent.innerHTML = content;
            aiFeatureModal.classList.remove('hidden');
            setTimeout(() => aiFeatureModal.classList.remove('opacity-0'), 10);
        }
        
        const spinner = `<div class="flex justify-center items-center h-full"><div class="w-8 h-8 border-4 border-cyan-400 border-t-transparent rounded-full spinner"></div></div>`;

        async function getCounterArguments() {
            if (isAILoading || !currentReportData) return;
            showAiModal('✨ Suggesting Counter-Arguments', spinner);
            try {
                const { title } = currentReportData;
                const { keyInsight, mainDebate } = currentReportData.expertTake;
                const schema = { type: "OBJECT", properties: { "counterArguments": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "title": { "type": "STRING" }, "argument": { "type": "STRING" } } } } } };
                const prompt = `Based on the expert analysis of "${title}" (Insight: "${keyInsight}", Debate: "${mainDebate}"), generate three strong, concise counter-arguments.`;
                const data = await callGeminiAPI(prompt, schema);
                const content = `<ul class="space-y-4">${data.counterArguments.map(arg => `<li class="p-3 bg-gray-700/50 rounded-lg"><strong class="block text-cyan-300">${arg.title}</strong><p>${arg.argument}</p></li>`).join('')}</ul>`;
                showAiModal('✨ Counter-Arguments', content);
            } catch (e) {
                showAiModal('Error', `<p class="text-red-400">Could not generate counter-arguments. ${e.message}</p>`);
            }
        }
        
        async function getActionableSteps() {
            if (isAILoading || !currentReportData) return;
            showAiModal('✨ Generating Actionable Steps', spinner);
            try {
                const { problem, title, level } = currentReportData;
                const schema = { type: "OBJECT", properties: { "actionableSteps": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "step": { "type": "STRING" }, "description": { "type": "STRING" } } } } } };
                const prompt = `For the problem of "${problem}" within the theme of "${title}", suggest three concrete, actionable first steps for a '${level}' level audience.`;
                const data = await callGeminiAPI(prompt, schema);
                const content = `<ol class="space-y-4 list-decimal list-inside">${data.actionableSteps.map(s => `<li class="p-3 bg-gray-700/50 rounded-lg"><strong class="block text-teal-300">${s.step}</strong><p>${s.description}</p></li>`).join('')}</ol>`;
                showAiModal('✨ Actionable Steps', content);
            } catch (e) {
                showAiModal('Error', `<p class="text-red-400">Could not generate actionable steps. ${e.message}</p>`);
            }
        }

        function resetApp() {
            resultsSection.classList.add('hidden');
            resultsSection.innerHTML = '';
            inputSection.classList.remove('hidden');
            document.querySelectorAll('.subtheme-tag.selected').forEach(tag => tag.classList.remove('selected'));
            problemStatementInput.value = '';
            setLoading(false);
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];
            currentReportData = null;
        }
    </script>
</body>
</html>
